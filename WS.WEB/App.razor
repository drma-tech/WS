@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.JSInterop
@using WS.WEB.Layout
@using Toolbelt.Blazor.PWA.Updater.Service

@inject NavigationManager Navigation
@inject IPWAUpdaterService PWAUpdaterService
@inject IJSRuntime JsRuntime

<CustomErrorBoundary @ref="_boundary" OnErrorCallback="OnAppError">
    <ChildContent>
        <Router AppAssembly="@typeof(App).Assembly">
            <Found Context="routeData">
                <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)" />
                <FocusOnNavigate RouteData="@routeData" Selector="h1" />
            </Found>
            <NotFound>
                <PageTitle>Not found</PageTitle>
                <LayoutView Layout="@typeof(MainLayout)">
                    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Dense="true">
                        Sorry, there's nothing at this address.
                    </MudAlert>
                </LayoutView>
            </NotFound>
        </Router>
    </ChildContent>
    <ErrorContent Context="ex">
        <div style="border: 1px solid #dc3545; background-color: #f8d7da; color: #721c24; padding: 16px; border-radius: 8px; max-width: 800px; margin: 40px auto;">
            <h3 style="margin-top: 0;">⚠️ Something went wrong</h3>

            <p style="margin: 8px 0;">
                Something unexpected happened and the app could not continue. We already received this error.
            </p>
            <p style="background:#fff; border:1px solid #ccc; padding:8px; border-radius:4px; max-height:200px; overflow:auto; font-size: 0.85rem; ">
                @ex.Message
            </p>

            <p style="margin-top: 40px;">
                In the meantime, you can try one of the following:
            </p>

            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                <button style="padding:8px 16px; background:#007bff; border:none; border-radius:4px; color:#fff; cursor:pointer;" @onclick="ReloadPage">
                    🔄 Refresh
                </button>
                @if (_isUpdateAvailable)
                {
                    <button style="padding:8px 16px; background:#007bff; border:none; border-radius:4px; color:#fff; cursor:pointer;" @onclick="UpdateNowAsync">
                        ⬆️ Force Update
                    </button>
                }
                else
                {
                    <button style="padding:8px 16px; background:#6c757d; border:none; border-radius:4px; color:#fff; cursor:unset">
                        New version not yet available.
                    </button>
                }
            </div>
        </div>
    </ErrorContent>
</CustomErrorBoundary>

@code {
    ErrorBoundary? _boundary;
    bool _isUpdateAvailable = false;
    System.Threading.Timer? _updateCheckTimer;

    protected override void OnParametersSet()
    {
        _boundary?.Recover();
    }

    private async Task OnAppError(Exception ex)
    {
        _isUpdateAvailable = await JsRuntime.InvokeAsync<bool>("checkUpdateReady");
        StateHasChanged();

        StartUpdatePolling();
    }

    void StartUpdatePolling()
    {
        if (_updateCheckTimer != null) return;

        _updateCheckTimer = new System.Threading.Timer(async _ =>
        {
            try
            {
                var available = await JsRuntime.InvokeAsync<bool>("checkUpdateReady");
                if (available && !_isUpdateAvailable)
                {
                    _isUpdateAvailable = true;
                    await InvokeAsync(StateHasChanged);

                    await _updateCheckTimer!.DisposeAsync();
                }
            }
            catch
            {
                // Ignore errors
            }
        }, null, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(2));
    }

    private async Task ReloadPage()
    {
        await JsRuntime.Utils().ClearLocalStorage();
        Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
    }

    private async Task UpdateNowAsync()
    {
        await JsRuntime.Utils().ClearLocalStorage();
        await this.PWAUpdaterService.SkipWaitingAsync();
    }

}
